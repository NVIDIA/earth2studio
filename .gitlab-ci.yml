stages:
  - clone
  - setup
  - lint
  - test
  - report
  - docs

github-clone:
  stage: clone
  rules:
    - if: $PIPELINE_REPO_SOURCE == "github"
  tags:
  - docker:dind
  extends:
    - .physicsnemo:github:pull
  image: bitnami/git

gitlab-clone:
  stage: clone
  rules:
    - if: $PIPELINE_REPO_SOURCE != "github" && $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $PIPELINE_REPO_SOURCE != "github"
      when: manual
  tags:
  - docker:dind
  extends:
    - .physicsnemo:gitlab:pull
  image: bitnami/git

.dind-base:
  image: docker:latest
  services:
    - name: docker:dind
      command: ["--tls=false"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2

build-image:
  stage: setup
  image: docker:latest
  services:
    - docker:dind
  tags:
    - docker-dind
  variables:
    # Tell docker CLI to talk to the docker service container
    DOCKER_HOST: tcp://docker:2376
    # Required for communicating with docker service
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "/certs/client"
    # Image name
    CI_IMAGE: earth2studio-ci:${CI_COMMIT_REF_SLUG}
  script:
    # Wait for docker service to be ready
    - until docker info; do sleep 1; done
    - cd src
    - ls
    - docker build -t $CI_IMAGE -f test/Dockerfile .
  cache:
    key: "$CI_PIPELINE_ID"
    paths:
      - src
    policy: pull

format:
  stage: lint
  tags:
  - docker
  extends:
    - .earth2studio:test:base
  script:
    - ls
    - make setup-ci
    - make format

lint:
  stage: lint
  tags:
  - docker
  extends:
    - .earth2studio:test:base
  script:
    - make setup-ci
    - make interrogate
    - make lint
    - make license

pytest:
  stage: test
  tags:
  - docker
  extends:
    - .earth2studio:test:base
  script:
    - make setup-ci
    - make install
    - coverage run -m pytest test/ --slow 2>&1 | tee ../blossom.log

coverage:
  stage: report
  tags:
  - docker
  extends:
    - .earth2studio:test:base
  script:
    - make setup-ci
    - make coverage 2>&1 | tee ../blossom.log
  dependencies:
    - pytest

pages:
  tags:
    - pages
  stage: docs
  script:
  - echo "Publishing docs!"
  - mkdir -p public
  - ls | grep -v public | xargs mv -t public
  publish: public
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_BRANCH == "gl-pages"

include:
  # - project: 'modulus/modulus-ci'
  #   ref: main
  #   file: '.gitlab-ci/earth2/studio/wheel.gitlab-ci.yml'

  # - project: 'modulus/modulus-ci'
  #   ref: main
  #   file: '.gitlab-ci/earth2/studio/docs.gitlab-ci.yml'

  - project: 'modulus/modulus-ci'
    ref: ngeneva/studio-reamped
    file: '.gitlab-ci/pull.gitlab-ci.yml'

  - project: 'modulus/modulus-ci'
    ref: ngeneva/studio-reamped
    file: '.gitlab-ci/earth2/studio/test.gitlab-ci.yml'
