
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/03_corrdiff_inference.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_03_corrdiff_inference.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_03_corrdiff_inference.py:


Generative Down Sampling
========================

Generative down-sampling over Taiwan using CorrDiff diffusion model.

This example will demonstrate how to user Nvidia's CorrDiff model, trained for
predicting weather over Taiwan, to perform generative downsampling from quater degree
global forcast data to ~3km.

In this example you will learn:

- Creating a custom workflow for running CorrDiff inference
- Creating a data-source for CorrDiff's input
- Initializing and running CorrDiff diagnostic model
- Post-processing results.

.. GENERATED FROM PYTHON SOURCE LINES 37-53

Creating a Simple CorrDiff Workflow
-----------------------------------

As usual, we start with creating a simple workflow to run CorrDiff in. To maximize the
generalizaiton of this workflow, we use dependency injection following the pattern
provided inside :py:obj:`earth2studio.run`. Since CorrDiff is a diagnostic model, this
workflow won't predict a time-series, rather just an instantaneous prediction.


For this workflow, we specify

- time: Input list of datetimes / strings to run inference for
- corrdiff: The initialized CorrDiffTaiwan model
- data: Initialized data source to fetch initial conditions from
- io: IOBackend
- number_of_samples: Number of samples to generate from the model

.. GENERATED FROM PYTHON SOURCE LINES 55-144

.. code-block:: Python

    from collections import OrderedDict
    from datetime import datetime

    import numpy as np
    import torch
    from loguru import logger

    from earth2studio.data import DataSource, prep_data_array
    from earth2studio.io import IOBackend
    from earth2studio.models.dx import CorrDiffTaiwan
    from earth2studio.utils.coords import map_coords, extract_coords
    from earth2studio.utils.time import to_time_array


    def run(
        time: list[str] | list[datetime] | list[np.datetime64],
        corrdiff: CorrDiffTaiwan,
        data: DataSource,
        io: IOBackend,
        number_of_samples: int = 1,
    ) -> IOBackend:
        """CorrDiff infernce workflow

        Parameters
        ----------
        time : list[str] | list[datetime] | list[np.datetime64]
            List of string, datetimes or np.datetime64
        corrdiff : CorrDiffTaiwan
            CorrDiff mode
        data : DataSource
            Data source
        io : IOBackend
            IO object
        number_of_samples : int, optional
            Number of samples to generate, by default 1

        Returns
        -------
        IOBackend
            Output IO object
        """
        logger.info("Running corrdiff inference!")
        device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
        logger.info(f"Inference device: {device}")

        corrdiff = corrdiff.to(device)
        # Update the number of samples for corrdiff to generate
        corrdiff.number_of_samples = number_of_samples

        # Fetch data from data source and load onto device
        time = to_time_array(time)
        x, coords = prep_data_array(
            data(time, corrdiff.input_coords["variable"]), device=device
        )
        x, coords = map_coords(x, coords, corrdiff.input_coords)

        logger.success(f"Fetched data from {data.__class__.__name__}")

        # Set up IO backend
        total_coords = OrderedDict(
            {
                "time": coords["time"],
                "sample": corrdiff.output_coords["sample"],
                "ilat": corrdiff.output_coords["ilat"],
                "ilon": corrdiff.output_coords["ilon"],
            }
        )
        io.add_array(total_coords, corrdiff.output_coords["variable"])

        # Add lat/lon grid metadata arrays
        io.add_array(
            OrderedDict({"ilat": total_coords["ilat"], "ilon": total_coords["ilon"]}),
            "lat",
            data=corrdiff.out_lat,
        )
        io.add_array(
            OrderedDict({"ilat": total_coords["ilat"], "ilon": total_coords["ilon"]}),
            "lon",
            data=corrdiff.out_lon,
        )

        logger.info("Inference starting!")
        x, coords = corrdiff(x, coords)
        io.write(*extract_coords(x, coords))

        logger.success("Inference complete")
        return io









.. GENERATED FROM PYTHON SOURCE LINES 145-156

Set Up
------
With the workflow defined, the next step is initialize the needed components from
Earth-2 studio

It's clear we need the following:

- Diagnostic Model: CorrDiff model for Taiwan :py:class:`earth2studio.models.dx.CorrDiffTaiwan`.
- Datasource: Pull data from the GFS data api :py:class:`earth2studio.data.GFS`.
- IO Backend: Lets save the outputs into a Zarr store :py:class:`earth2studio.io.ZarrBackend`.


.. GENERATED FROM PYTHON SOURCE LINES 158-175

.. code-block:: Python

    from dotenv import load_dotenv

    from earth2studio.io import ZarrBackend
    from earth2studio.data import GFS

    load_dotenv()  # TODO: make common example prep function

    # Create CorrDiff model
    package = CorrDiffTaiwan.load_default_package()
    corrdiff = CorrDiffTaiwan.load_model(package)

    # Create the data source
    data = GFS()

    # Create the IO handler, store in memory
    io = ZarrBackend()








.. GENERATED FROM PYTHON SOURCE LINES 176-185

Execute the Workflow
--------------------
With all componments intialized, running the workflow is a single line of Python code.
Workflow will return the provided IO object back to the user, which can be used to
then post process. Some have additional APIs that can be handy for post-processing or
saving to file. Check the API docs for more information.

For the inference we will predict 1 sample for a particular timestamp representing
Typhon Koinu

.. GENERATED FROM PYTHON SOURCE LINES 187-189

.. code-block:: Python

    io = run(["2023-10-04T18:00:00"], corrdiff, data, io, number_of_samples=1)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2024-04-12 23:54:32.090 | INFO     | __main__:run:96 - Running corrdiff inference!
    2024-04-12 23:54:32.091 | INFO     | __main__:run:98 - Inference device: cuda
    2024-04-12 23:54:32.175 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:151 - Fetching GFS index file: 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:   0%|          | 0/12 [00:00<?, ?it/s]                                                                                2024-04-12 23:54:32.565 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: tcwv at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:   0%|          | 0/12 [00:00<?, ?it/s]    Fetching GFS for 2023-10-04 18:00:00:   8%|▊         | 1/12 [00:00<00:08,  1.37it/s]                                                                                        2024-04-12 23:54:33.297 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: z500 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:   8%|▊         | 1/12 [00:00<00:08,  1.37it/s]    Fetching GFS for 2023-10-04 18:00:00:  17%|█▋        | 2/12 [00:01<00:05,  1.83it/s]                                                                                        2024-04-12 23:54:33.715 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: t500 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  17%|█▋        | 2/12 [00:01<00:05,  1.83it/s]    Fetching GFS for 2023-10-04 18:00:00:  25%|██▌       | 3/12 [00:01<00:04,  2.08it/s]                                                                                        2024-04-12 23:54:34.116 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: u500 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  25%|██▌       | 3/12 [00:01<00:04,  2.08it/s]    Fetching GFS for 2023-10-04 18:00:00:  33%|███▎      | 4/12 [00:01<00:03,  2.56it/s]                                                                                        2024-04-12 23:54:34.370 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: v500 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  33%|███▎      | 4/12 [00:01<00:03,  2.56it/s]    Fetching GFS for 2023-10-04 18:00:00:  42%|████▏     | 5/12 [00:02<00:02,  2.86it/s]                                                                                        2024-04-12 23:54:34.647 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: z850 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  42%|████▏     | 5/12 [00:02<00:02,  2.86it/s]    Fetching GFS for 2023-10-04 18:00:00:  50%|█████     | 6/12 [00:02<00:02,  2.83it/s]                                                                                        2024-04-12 23:54:35.007 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: t850 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  50%|█████     | 6/12 [00:02<00:02,  2.83it/s]    Fetching GFS for 2023-10-04 18:00:00:  58%|█████▊    | 7/12 [00:02<00:01,  2.85it/s]                                                                                        2024-04-12 23:54:35.352 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: u850 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  58%|█████▊    | 7/12 [00:02<00:01,  2.85it/s]    Fetching GFS for 2023-10-04 18:00:00:  67%|██████▋   | 8/12 [00:03<00:01,  3.05it/s]                                                                                        2024-04-12 23:54:35.632 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: v850 at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  67%|██████▋   | 8/12 [00:03<00:01,  3.05it/s]    Fetching GFS for 2023-10-04 18:00:00:  75%|███████▌  | 9/12 [00:03<00:00,  3.26it/s]                                                                                        2024-04-12 23:54:35.893 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: t2m at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  75%|███████▌  | 9/12 [00:03<00:00,  3.26it/s]    Fetching GFS for 2023-10-04 18:00:00:  83%|████████▎ | 10/12 [00:03<00:00,  2.71it/s]                                                                                         2024-04-12 23:54:36.399 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: u10m at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  83%|████████▎ | 10/12 [00:03<00:00,  2.71it/s]    Fetching GFS for 2023-10-04 18:00:00:  92%|█████████▏| 11/12 [00:04<00:00,  2.92it/s]                                                                                         2024-04-12 23:54:36.684 | DEBUG    | earth2studio.data.gfs:fetch_gfs_dataarray:197 - Fetching GFS grib file for variable: v10m at 2023-10-04 18:00:00
    Fetching GFS for 2023-10-04 18:00:00:  92%|█████████▏| 11/12 [00:04<00:00,  2.92it/s]    Fetching GFS for 2023-10-04 18:00:00: 100%|██████████| 12/12 [00:04<00:00,  3.15it/s]    Fetching GFS for 2023-10-04 18:00:00: 100%|██████████| 12/12 [00:04<00:00,  2.74it/s]
    2024-04-12 23:54:36.967 | SUCCESS  | __main__:run:111 - Fetched data from GFS
    2024-04-12 23:54:36.972 | INFO     | __main__:run:136 - Inference starting!
    2024-04-12 23:54:38.150 | SUCCESS  | __main__:run:140 - Inference complete




.. GENERATED FROM PYTHON SOURCE LINES 190-196

Post Processing
---------------
The last step is to post process our results. Cartopy is a great library for plotting
fields on projections of a sphere.

Notice that the Zarr IO function has additional APIs to interact with the stored data.

.. GENERATED FROM PYTHON SOURCE LINES 198-247

.. code-block:: Python

    import matplotlib.pyplot as plt
    import cartopy.crs as ccrs

    projection = ccrs.LambertConformal(
        central_longitude=io["lon"][:].mean(),
    )

    fig = plt.figure(figsize=(4 * 8, 8))

    ax0 = fig.add_subplot(1, 3, 1, projection=projection)
    c = ax0.pcolormesh(
        io["lon"],
        io["lat"],
        io["mrr"][0, 0],
        transform=ccrs.PlateCarree(),
        cmap="inferno",
    )
    plt.colorbar(c, ax=ax0, shrink=0.6, label="mrr dBz")
    ax0.coastlines()
    ax0.gridlines()
    ax0.set_title("Radar Reflectivity")

    ax1 = fig.add_subplot(1, 3, 2, projection=projection)
    c = ax1.pcolormesh(
        io["lon"],
        io["lat"],
        io["t2m"][0, 0],
        transform=ccrs.PlateCarree(),
        cmap="RdBu_r",
    )
    plt.colorbar(c, ax=ax1, shrink=0.6, label="K")
    ax1.coastlines()
    ax1.gridlines()
    ax1.set_title("2-meter Temperature")

    ax2 = fig.add_subplot(1, 3, 3, projection=projection)
    c = ax2.pcolormesh(
        io["lon"],
        io["lat"],
        np.sqrt(io["u10m"][0, 0] ** 2 + io["v10m"][0, 0] ** 2),
        transform=ccrs.PlateCarree(),
        cmap="Greens",
    )
    plt.colorbar(c, ax=ax2, shrink=0.6, label="w10m m s^-1")
    ax2.coastlines()
    ax2.gridlines()
    ax2.set_title("10-meter Wind Speed")

    plt.savefig(f"outputs/03_corr_diff_prediction.jpg")



.. image-sg:: /examples/images/sphx_glr_03_corrdiff_inference_001.png
   :alt: Radar Reflectivity, 2-meter Temperature, 10-meter Wind Speed
   :srcset: /examples/images/sphx_glr_03_corrdiff_inference_001.png, /examples/images/sphx_glr_03_corrdiff_inference_001_2_00x.png 2.00x
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /usr/local/lib/python3.10/dist-packages/cartopy/io/__init__.py:241: DownloadWarning: Downloading: https://naturalearth.s3.amazonaws.com/10m_physical/ne_10m_coastline.zip
      warnings.warn(f'Downloading: {url}', DownloadWarning)





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 15.057 seconds)


.. _sphx_glr_download_examples_03_corrdiff_inference.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 03_corrdiff_inference.ipynb <03_corrdiff_inference.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 03_corrdiff_inference.py <03_corrdiff_inference.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
