
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/17_io_performance.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_17_io_performance.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_17_io_performance.py:


IO Backend Performance
========================

Leverage different IO backends for storing inference results.

This example explores IO backends inside Earth2Studio and how they can be used to write
data to different formats / locations. The IO is a core part of any inference pipeline
and depending on the desired target, can dramatically impact performance. This example
will help navigate users through the use of different IO backend APIs in a simple
workflow.

In this example you will learn:

- Initializing, creating arrays and writing with the Zarr IO backend
- Initializing, creating arrays and writing with the NetCDF IO backend
- Initializing and writing with the Asynchronous Non-blocking Zarr IO backend
- Discussing performance implications and strategies that can be used

.. GENERATED FROM PYTHON SOURCE LINES 37-44

.. code-block:: Python

    # /// script
    # dependencies = [
    #   "earth2studio[dlwp] @ git+https://github.com/NVIDIA/earth2studio.git@0.9.0",
    #   "matplotlib",
    # ]
    # ///








.. GENERATED FROM PYTHON SOURCE LINES 45-50

Set Up
------
To demonstrate different IO, this example will use a simple ensemble workflow that we
will manually create ourselves. One could use the built in workflow in Earth2Studio
however, this will allow us to better understand the APIs.

.. GENERATED FROM PYTHON SOURCE LINES 52-58

We need the following components:

- Datasource: Pull data from the GFS data api :py:class:`earth2studio.data.GFS`.
- Prognostic Model: Use the built in DLWP model :py:class:`earth2studio.models.px.DLWP`.
- Perturbation Method: Use the standard Gaussian method :py:class:`earth2studio.perturbation.Gaussian`.
- IO Backends: Use a few IO Backends including :py:class:`earth2studio.io.AsyncZarrBackend`, :py:class:`earth2studio.io.NetCDF4Backend` and :py:class:`earth2studio.io.ZarrBackend`.

.. GENERATED FROM PYTHON SOURCE LINES 60-89

.. code-block:: Python


    import os

    os.makedirs("outputs", exist_ok=True)
    from dotenv import load_dotenv

    load_dotenv()  # TODO: make common example prep function

    import torch

    from earth2studio.data import GFS, DataSource, fetch_data
    from earth2studio.io import AsyncZarrBackend, IOBackend, NetCDF4Backend, ZarrBackend
    from earth2studio.models.px import DLWP, PrognosticModel
    from earth2studio.perturbation import Gaussian, Perturbation

    # Get the device
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

    # Load the cBottle data source
    package = DLWP.load_default_package()
    model = DLWP.load_model(package)
    model = model.to(device)

    # Create the ERA5 data source
    ds = GFS()

    # Create perturbation method
    pt = Gaussian()








.. GENERATED FROM PYTHON SOURCE LINES 90-97

Creating a Simple Ensemble Workflow
-----------------------------------
Start with creating a simple ensemble inference workflow. This is essentially a
simpler version of the built in ensemble workflow :py:meth:`earth2studio.run.ensemble`.
In this case, this is for an ensemble inference workflow that will predict a 5 day
forecast for Christmas 2022. Following standard Earth2Studio practices, the function
accepts initialized prognostic, data source, io backend and perturbation method.

.. GENERATED FROM PYTHON SOURCE LINES 99-200

.. code-block:: Python


    import os
    import time
    from datetime import datetime, timedelta

    import numpy as np
    from tqdm import tqdm

    from earth2studio.utils.coords import map_coords, split_coords
    from earth2studio.utils.time import to_time_array

    times = [datetime(2022, 12, 20)]
    nsteps = 20  # Assuming 6-hour time steps


    def christmas_five_day_ensemble(
        times: list[datetime],
        nsteps: int,
        prognostic: PrognosticModel,
        data: DataSource,
        io: IOBackend,
        perturbation: Perturbation,
        nensemble: int = 8,
        device: str = "cuda",
    ) -> None:
        """Ensemble inference example"""
        # ==========================================
        # Fetch Initialization Data
        prognostic_ic = prognostic.input_coords()
        times = to_time_array(times)

        x, coords0 = fetch_data(
            source=data,
            time=times,
            variable=prognostic_ic["variable"],
            lead_time=prognostic_ic["lead_time"],
            device=device,
        )
        # ==========================================
        # ==========================================
        # Set up IO backend by pre-allocating arrays (not needed for AsyncZarrBackend)
        total_coords = prognostic.output_coords(prognostic.input_coords()).copy()
        if "batch" in total_coords:
            del total_coords["batch"]
        total_coords["time"] = times
        total_coords["lead_time"] = np.asarray(
            [
                prognostic.output_coords(prognostic.input_coords())["lead_time"] * i
                for i in range(nsteps + 1)
            ]
        ).flatten()
        total_coords.move_to_end("lead_time", last=False)
        total_coords.move_to_end("time", last=False)
        total_coords = {"ensemble": np.arange(nensemble)} | total_coords

        variables_to_save = total_coords.pop("variable")
        io.add_array(total_coords, variables_to_save)
        # ==========================================
        # ==========================================
        # Run inference
        coords = {"ensemble": np.arange(nensemble)} | coords0.copy()
        x = x.unsqueeze(0).repeat(nensemble, *([1] * x.ndim))

        # Map lat and lon if needed
        x, coords = map_coords(x, coords, prognostic_ic)

        # Perturb ensemble
        x, coords = perturbation(x, coords)

        # Create prognostic iterator
        model = prognostic.create_iterator(x, coords)

        with tqdm(
            total=nsteps + 1,
            desc="Running batch inference",
            position=1,
            leave=False,
        ) as pbar:
            for step, (x, coords) in enumerate(model):
                # Dump result to IO, split_coords separates variables to different arrays
                x, coords = map_coords(x, coords, {"variable": np.array(["t2m", "tcwv"])})
                io.write(*split_coords(x, coords))
                pbar.update(1)
                if step == nsteps:
                    break
        # ==========================================


    def get_folder_size(folder_path: str) -> int:
        """Get folder size in megabytes"""
        if os.path.isfile(folder_path):
            return os.path.getsize(folder_path) / (1024 * 1024)

        total_size = 0
        for dirpath, dirnames, filenames in os.walk(folder_path):
            for filename in filenames:
                file_path = os.path.join(dirpath, filename)
                total_size += os.path.getsize(file_path)
        return total_size / (1024 * 1024)









.. GENERATED FROM PYTHON SOURCE LINES 201-209

Local Storage Zarr IO
---------------------
As a base line, lets run the Zarr IO backend saving it to local disk.
Local IO storage is typically preferred since we can then access the data after the
inference pipeline is finished using standard libraries.
Chunking play an important role on performance, both with respect to compression and
also when accessing data.
Here we will chunk the output data based on time and lead_time

.. GENERATED FROM PYTHON SOURCE LINES 211-222

.. code-block:: Python


    io = ZarrBackend(
        "outputs/17_io_sync.zarr",
        chunks={"time": 1, "lead_time": 1},
        backend_kwargs={"overwrite": True},
    )

    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    zarr_local_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.435 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.437 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.439 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.441 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.443 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.445 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:44.446 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:03,  1.92it/s]    Fetching GFS data:  29%|██▊       | 2/7 [00:00<00:01,  3.14it/s]    Fetching GFS data:  86%|████████▌ | 6/7 [00:01<00:00,  6.62it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:02<00:00,  2.23it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:02<00:00,  2.66it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.528 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.530 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.532 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.533 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.535 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.537 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:27:47.539 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:03,  1.87it/s]    Fetching GFS data:  29%|██▊       | 2/7 [00:00<00:01,  3.19it/s]    Fetching GFS data:  57%|█████▋    | 4/7 [00:01<00:01,  2.29it/s]    Fetching GFS data:  71%|███████▏  | 5/7 [00:02<00:00,  2.31it/s]    Fetching GFS data:  86%|████████▌ | 6/7 [00:03<00:00,  1.18it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:04<00:00,  1.32it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:04<00:00,  1.56it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
    Running batch inference:   5%|▍         | 1/21 [00:00<00:11,  1.74it/s]
    Running batch inference:  10%|▉         | 2/21 [00:01<00:11,  1.61it/s]
    Running batch inference:  14%|█▍        | 3/21 [00:01<00:11,  1.62it/s]
    Running batch inference:  19%|█▉        | 4/21 [00:02<00:10,  1.63it/s]
    Running batch inference:  24%|██▍       | 5/21 [00:03<00:09,  1.63it/s]
    Running batch inference:  29%|██▊       | 6/21 [00:03<00:09,  1.64it/s]
    Running batch inference:  33%|███▎      | 7/21 [00:04<00:08,  1.65it/s]
    Running batch inference:  38%|███▊      | 8/21 [00:04<00:07,  1.63it/s]
    Running batch inference:  43%|████▎     | 9/21 [00:05<00:07,  1.65it/s]
    Running batch inference:  48%|████▊     | 10/21 [00:06<00:06,  1.62it/s]
    Running batch inference:  52%|█████▏    | 11/21 [00:06<00:06,  1.62it/s]
    Running batch inference:  57%|█████▋    | 12/21 [00:07<00:05,  1.60it/s]
    Running batch inference:  62%|██████▏   | 13/21 [00:08<00:05,  1.60it/s]
    Running batch inference:  67%|██████▋   | 14/21 [00:08<00:04,  1.60it/s]
    Running batch inference:  71%|███████▏  | 15/21 [00:09<00:03,  1.62it/s]
    Running batch inference:  76%|███████▌  | 16/21 [00:09<00:03,  1.60it/s]
    Running batch inference:  81%|████████  | 17/21 [00:10<00:02,  1.60it/s]
    Running batch inference:  86%|████████▌ | 18/21 [00:11<00:01,  1.60it/s]
    Running batch inference:  90%|█████████ | 19/21 [00:11<00:01,  1.61it/s]
    Running batch inference:  95%|█████████▌| 20/21 [00:12<00:00,  1.59it/s]
    Running batch inference: 100%|██████████| 21/21 [00:12<00:00,  1.61it/s]
                                                                            



.. GENERATED FROM PYTHON SOURCE LINES 223-229

.. code-block:: Python


    print(f"\nLocal zarr store inference time: {zarr_local_clock}s")
    print(
        f"Uncompressed zarr store size: {get_folder_size('outputs/17_io_sync.zarr'):.2f} MB"
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Local zarr store inference time: 21.036999464035034s
    Uncompressed zarr store size: 1330.78 MB




.. GENERATED FROM PYTHON SOURCE LINES 230-238

Compressed Local Storage Zarr IO
--------------------------------
By default the Zarr IO backends will be uncompressed.
In many instances this is fine, when data volumes are low.
However, in instances that we are writing a very large amount of data or the data
needs to get sent over the network to a remote store, compression is essential.
With the standard Zarr backend, this will cause a very noticeable slow down, but note
that the output store will be 3x smaller!

.. GENERATED FROM PYTHON SOURCE LINES 240-256

.. code-block:: Python


    import zarr

    io = ZarrBackend(
        "outputs/17_io_sync_compressed.zarr",
        chunks={"time": 1, "lead_time": 1},
        backend_kwargs={"overwrite": True},
        zarr_codecs=zarr.codecs.BloscCodec(
            cname="zstd", clevel=3, shuffle=zarr.codecs.BloscShuffle.shuffle
        ),  # Zarrs default
    )

    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    zarr_local_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.152 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.178 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.200 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.223 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.245 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.267 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.289 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.24it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 43.63it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.321 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.343 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.366 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.388 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.410 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.432 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:05.455 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.37it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.50it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
    Running batch inference:   5%|▍         | 1/21 [00:00<00:19,  1.00it/s]
    Running batch inference:  10%|▉         | 2/21 [00:02<00:19,  1.04s/it]
    Running batch inference:  14%|█▍        | 3/21 [00:03<00:18,  1.05s/it]
    Running batch inference:  19%|█▉        | 4/21 [00:04<00:17,  1.05s/it]
    Running batch inference:  24%|██▍       | 5/21 [00:05<00:16,  1.06s/it]
    Running batch inference:  29%|██▊       | 6/21 [00:06<00:16,  1.08s/it]
    Running batch inference:  33%|███▎      | 7/21 [00:07<00:14,  1.07s/it]
    Running batch inference:  38%|███▊      | 8/21 [00:08<00:13,  1.08s/it]
    Running batch inference:  43%|████▎     | 9/21 [00:09<00:12,  1.06s/it]
    Running batch inference:  48%|████▊     | 10/21 [00:10<00:11,  1.06s/it]
    Running batch inference:  52%|█████▏    | 11/21 [00:11<00:10,  1.07s/it]
    Running batch inference:  57%|█████▋    | 12/21 [00:12<00:09,  1.07s/it]
    Running batch inference:  62%|██████▏   | 13/21 [00:13<00:08,  1.08s/it]
    Running batch inference:  67%|██████▋   | 14/21 [00:14<00:07,  1.06s/it]
    Running batch inference:  71%|███████▏  | 15/21 [00:15<00:06,  1.07s/it]
    Running batch inference:  76%|███████▌  | 16/21 [00:16<00:05,  1.05s/it]
    Running batch inference:  81%|████████  | 17/21 [00:17<00:04,  1.04s/it]
    Running batch inference:  86%|████████▌ | 18/21 [00:19<00:03,  1.04s/it]
    Running batch inference:  90%|█████████ | 19/21 [00:20<00:02,  1.03s/it]
    Running batch inference:  95%|█████████▌| 20/21 [00:21<00:01,  1.04s/it]
    Running batch inference: 100%|██████████| 21/21 [00:22<00:00,  1.04s/it]
                                                                            



.. GENERATED FROM PYTHON SOURCE LINES 257-264

.. code-block:: Python


    print(f"\nLocal compressed zarr store inference time: {zarr_local_clock}s")
    print(
        f"Compressed zarr store size: {get_folder_size('outputs/17_io_sync_compressed.zarr'):.2f} MB"
    )






.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Local compressed zarr store inference time: 22.566855669021606s
    Compressed zarr store size: 413.08 MB




.. GENERATED FROM PYTHON SOURCE LINES 265-271

Local Storage NetCDF IO
-----------------------
NetCDF offers a similar user experience but saves the output into a single netCDF
file.
For local storage, NetCDF it typically preferred since it keeps all outputs into
a single file.

.. GENERATED FROM PYTHON SOURCE LINES 273-279

.. code-block:: Python


    io = NetCDF4Backend("outputs/17_io_sync.nc", backend_kwargs={"mode": "w"})
    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    nc_local_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.720 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.744 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.767 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.789 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.812 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.836 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.859 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.22it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 43.47it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.890 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.913 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.936 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.959 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:27.981 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:28.004 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:28.026 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.30it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.08it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
    Running batch inference:   5%|▍         | 1/21 [00:00<00:16,  1.20it/s]
    Running batch inference:  19%|█▉        | 4/21 [00:00<00:03,  5.24it/s]
    Running batch inference:  33%|███▎      | 7/21 [00:01<00:01,  9.40it/s]
    Running batch inference:  48%|████▊     | 10/21 [00:01<00:00, 12.91it/s]
    Running batch inference:  62%|██████▏   | 13/21 [00:01<00:00, 16.49it/s]
    Running batch inference:  76%|███████▌  | 16/21 [00:01<00:00, 18.79it/s]
    Running batch inference:  90%|█████████ | 19/21 [00:01<00:00, 21.47it/s]
                                                                            



.. GENERATED FROM PYTHON SOURCE LINES 280-286

.. code-block:: Python


    print(f"\nLocal netcdf store inference time: {nc_local_clock}s")
    print(
        f"Uncompressed zarr store size: {get_folder_size('outputs/17_io_sync.nc'):.2f} MB"
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Local netcdf store inference time: 1.9417569637298584s
    Uncompressed zarr store size: 1330.79 MB




.. GENERATED FROM PYTHON SOURCE LINES 287-293

In Memory Zarr IO
-----------------
One way we can speed up IO is to save outputs to in-memory stores.
In-memory stores more limited in size depending on the hardware being used.
Also one needs to be careful with in memory stores, once the Python object is deleted
the data is gone.

.. GENERATED FROM PYTHON SOURCE LINES 295-303

.. code-block:: Python


    io = ZarrBackend(
        chunks={"time": 1, "lead_time": 1}, backend_kwargs={"overwrite": True}
    )  # Not path = in memory for Zarr
    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    zarr_memory_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.664 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.687 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.710 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.732 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.755 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.778 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.800 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.32it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.22it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.831 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.853 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.876 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.898 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.921 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.943 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:29.966 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.37it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.51it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
    Running batch inference:   5%|▍         | 1/21 [00:00<00:10,  1.85it/s]
    Running batch inference:  10%|▉         | 2/21 [00:01<00:10,  1.84it/s]
    Running batch inference:  14%|█▍        | 3/21 [00:01<00:09,  1.86it/s]
    Running batch inference:  19%|█▉        | 4/21 [00:02<00:11,  1.49it/s]
    Running batch inference:  24%|██▍       | 5/21 [00:03<00:09,  1.62it/s]
    Running batch inference:  29%|██▊       | 6/21 [00:03<00:08,  1.69it/s]
    Running batch inference:  33%|███▎      | 7/21 [00:04<00:07,  1.75it/s]
    Running batch inference:  38%|███▊      | 8/21 [00:04<00:07,  1.79it/s]
    Running batch inference:  43%|████▎     | 9/21 [00:05<00:06,  1.82it/s]
    Running batch inference:  48%|████▊     | 10/21 [00:05<00:05,  1.84it/s]
    Running batch inference:  52%|█████▏    | 11/21 [00:06<00:05,  1.86it/s]
    Running batch inference:  57%|█████▋    | 12/21 [00:07<00:06,  1.46it/s]
    Running batch inference:  62%|██████▏   | 13/21 [00:07<00:05,  1.57it/s]
    Running batch inference:  67%|██████▋   | 14/21 [00:08<00:04,  1.65it/s]
    Running batch inference:  71%|███████▏  | 15/21 [00:08<00:03,  1.71it/s]
    Running batch inference:  76%|███████▌  | 16/21 [00:09<00:02,  1.76it/s]
    Running batch inference:  81%|████████  | 17/21 [00:09<00:02,  1.81it/s]
    Running batch inference:  86%|████████▌ | 18/21 [00:10<00:01,  1.81it/s]
    Running batch inference:  90%|█████████ | 19/21 [00:10<00:01,  1.83it/s]
    Running batch inference:  95%|█████████▌| 20/21 [00:11<00:00,  1.81it/s]
    Running batch inference: 100%|██████████| 21/21 [00:12<00:00,  1.80it/s]
                                                                            



.. GENERATED FROM PYTHON SOURCE LINES 304-307

.. code-block:: Python


    print(f"\nIn memory zarr store inference time: {zarr_memory_clock}s")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    In memory zarr store inference time: 12.465613603591919s




.. GENERATED FROM PYTHON SOURCE LINES 308-321

Compressed Local Async Zarr IO
------------------------------
The async Zarr IO backend is an advanced IO backend designed to offer async
Zarr 3.0 writes to in-memory, local and remote data stores.
This data source is ideal when large volumes of data are needed to be written and
the users want to mask the IO with the forward execution of the model.

Because this IO backend relies on both async and multi-threading, it has a different
initialization pattern than others.
The main difference being that this backend does not use the add_array API, rather
users specify `parallel_coords` in the constructor that denote coords that slices will
be written to during inference.
Typically this might be `time`, `lead_time` and `ensemble`.

.. GENERATED FROM PYTHON SOURCE LINES 323-341

.. code-block:: Python


    parallel_coords = {
        "time": np.array(times, dtype=np.datetime64),
        "lead_time": np.array(
            [timedelta(hours=6 * i) for i in range(nsteps + 1)], dtype=np.timedelta64
        ),
    }
    io = AsyncZarrBackend(
        "outputs/17_io_async.zarr",
        parallel_coords=parallel_coords,
        zarr_codecs=zarr.codecs.BloscCodec(
            cname="zstd", clevel=3, shuffle=zarr.codecs.BloscShuffle.shuffle
        ),
    )
    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    zarr_async_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2025-08-14 00:28:42.125 | DEBUG    | earth2studio.io.async_zarr:__init__:167 - Setting up Zarr object pool of size 1, may take a bit
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.138 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.162 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.184 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.207 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.230 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.252 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.274 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.35it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.37it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.304 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.327 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.349 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.371 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.393 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.415 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:42.438 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.40it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.77it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.503 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array ensemble to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.506 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array time to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.509 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lead_time to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.512 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lat to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.515 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lon to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.518 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array t2m with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.520 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array tcwv with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:42.565 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
    Running batch inference:   5%|▍         | 1/21 [00:00<00:08,  2.33it/s]
                                                                           2025-08-14 00:28:43.013 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:   5%|▍         | 1/21 [00:00<00:08,  2.33it/s]
    Running batch inference:  10%|▉         | 2/21 [00:00<00:08,  2.36it/s]
                                                                           2025-08-14 00:28:43.437 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  10%|▉         | 2/21 [00:00<00:08,  2.36it/s]
    Running batch inference:  14%|█▍        | 3/21 [00:01<00:07,  2.52it/s]
                                                                           2025-08-14 00:28:43.848 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  14%|█▍        | 3/21 [00:01<00:07,  2.52it/s]
    Running batch inference:  19%|█▉        | 4/21 [00:01<00:06,  2.47it/s]
                                                                           2025-08-14 00:28:44.200 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  19%|█▉        | 4/21 [00:01<00:06,  2.47it/s]
    Running batch inference:  24%|██▍       | 5/21 [00:01<00:06,  2.60it/s]
                                                                           2025-08-14 00:28:44.584 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  24%|██▍       | 5/21 [00:02<00:06,  2.60it/s]
    Running batch inference:  29%|██▊       | 6/21 [00:02<00:05,  2.54it/s]
                                                                           2025-08-14 00:28:44.947 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  29%|██▊       | 6/21 [00:02<00:05,  2.54it/s]
    Running batch inference:  33%|███▎      | 7/21 [00:02<00:05,  2.65it/s]
                                                                           2025-08-14 00:28:45.314 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  33%|███▎      | 7/21 [00:02<00:05,  2.65it/s]
    Running batch inference:  38%|███▊      | 8/21 [00:03<00:04,  2.67it/s]
                                                                           2025-08-14 00:28:45.668 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  38%|███▊      | 8/21 [00:03<00:04,  2.67it/s]
    Running batch inference:  43%|████▎     | 9/21 [00:03<00:04,  2.72it/s]
                                                                           2025-08-14 00:28:46.055 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  43%|████▎     | 9/21 [00:03<00:04,  2.72it/s]
    Running batch inference:  48%|████▊     | 10/21 [00:03<00:04,  2.68it/s]
                                                                            2025-08-14 00:28:46.397 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  48%|████▊     | 10/21 [00:03<00:04,  2.68it/s]
    Running batch inference:  52%|█████▏    | 11/21 [00:04<00:03,  2.75it/s]
                                                                            2025-08-14 00:28:46.763 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  52%|█████▏    | 11/21 [00:04<00:03,  2.75it/s]
    Running batch inference:  57%|█████▋    | 12/21 [00:04<00:03,  2.75it/s]
                                                                            2025-08-14 00:28:47.105 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  57%|█████▋    | 12/21 [00:04<00:03,  2.75it/s]
    Running batch inference:  62%|██████▏   | 13/21 [00:04<00:02,  2.80it/s]
                                                                            2025-08-14 00:28:47.466 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  62%|██████▏   | 13/21 [00:04<00:02,  2.80it/s]
    Running batch inference:  67%|██████▋   | 14/21 [00:05<00:02,  2.78it/s]
                                                                            2025-08-14 00:28:47.811 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  67%|██████▋   | 14/21 [00:05<00:02,  2.78it/s]
    Running batch inference:  71%|███████▏  | 15/21 [00:05<00:02,  2.82it/s]
                                                                            2025-08-14 00:28:48.173 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  71%|███████▏  | 15/21 [00:05<00:02,  2.82it/s]
    Running batch inference:  76%|███████▌  | 16/21 [00:05<00:01,  2.78it/s]
                                                                            2025-08-14 00:28:48.555 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  76%|███████▌  | 16/21 [00:06<00:01,  2.78it/s]
    Running batch inference:  81%|████████  | 17/21 [00:06<00:01,  2.70it/s]
                                                                            2025-08-14 00:28:48.943 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  81%|████████  | 17/21 [00:06<00:01,  2.70it/s]
    Running batch inference:  86%|████████▌ | 18/21 [00:06<00:01,  2.68it/s]
                                                                            2025-08-14 00:28:49.304 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  86%|████████▌ | 18/21 [00:06<00:01,  2.68it/s]
    Running batch inference:  90%|█████████ | 19/21 [00:07<00:00,  2.71it/s]
                                                                            2025-08-14 00:28:49.705 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  90%|█████████ | 19/21 [00:07<00:00,  2.71it/s]
    Running batch inference:  95%|█████████▌| 20/21 [00:07<00:00,  2.61it/s]
                                                                            2025-08-14 00:28:50.063 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  95%|█████████▌| 20/21 [00:07<00:00,  2.61it/s]
    Running batch inference: 100%|██████████| 21/21 [00:07<00:00,  2.67it/s]
                                                                            



.. GENERATED FROM PYTHON SOURCE LINES 342-348

.. code-block:: Python


    print(f"\nAsync zarr store inference time: {zarr_async_clock}s")
    print(
        f"Compressed async zarr store size: {get_folder_size('outputs/17_io_async.zarr'):.2f} MB"
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Async zarr store inference time: 8.240005493164062s
    Compressed async zarr store size: 413.08 MB




.. GENERATED FROM PYTHON SOURCE LINES 349-361

Compressed Local Non-Blocking Async Zarr IO
-------------------------------------------
That was faster than the normal Zarr method, even the uncompressed version making it
comparable to NetCDF, but we can still improve with this IO backend.
A unique feature of this particular backend is running in non-blocking mode, namely
IO writes will be placed onto other threads.
Users do need to be careful with this to both ensure data is not mutated while the IO
backend is working to move the data off the GPU, but also to make sure to wait for
write threads to finish before the object is deleted.

Note that this backend allows Zarr to be comparable to uncompressed NetCDF even 3x
compression!

.. GENERATED FROM PYTHON SOURCE LINES 363-378

.. code-block:: Python


    io = AsyncZarrBackend(
        "outputs/17_io_nonblocking_async.zarr",
        parallel_coords=parallel_coords,
        blocking=False,
        zarr_codecs=zarr.codecs.BloscCodec(
            cname="zstd", clevel=3, shuffle=zarr.codecs.BloscShuffle.shuffle
        ),
    )
    start_time = time.time()
    christmas_five_day_ensemble(times, nsteps, model, ds, io, pt, device=device)
    # IMPORTANT: Make sure to call close to ensure IO backend threads have finished!
    io.close()
    zarr_nonblocking_async_clock = time.time() - start_time





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2025-08-14 00:28:50.383 | DEBUG    | earth2studio.io.async_zarr:__init__:167 - Setting up Zarr object pool of size 8, may take a bit
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.407 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.430 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.453 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.475 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.498 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.521 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.543 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.32it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.16it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.574 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.597 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.619 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.642 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.665 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.687 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:28:50.709 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.38it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 44.60it/s]

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.774 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array ensemble to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.777 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array time to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.780 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lead_time to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.782 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lat to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.785 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lon to zarr store

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.788 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array t2m with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.789 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array tcwv with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/21 [00:00<?, ?it/s]
                                                                   2025-08-14 00:28:50.845 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:   5%|▍         | 1/21 [00:00<00:01, 13.13it/s]
    Running batch inference:  10%|▉         | 2/21 [00:00<00:01, 16.91it/s]
                                                                           2025-08-14 00:28:50.940 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  10%|▉         | 2/21 [00:00<00:01, 16.91it/s]
                                                                           2025-08-14 00:28:51.034 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  14%|█▍        | 3/21 [00:00<00:01, 16.91it/s]
    Running batch inference:  19%|█▉        | 4/21 [00:00<00:01, 12.01it/s]
                                                                           2025-08-14 00:28:51.142 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  19%|█▉        | 4/21 [00:00<00:01, 12.01it/s]
                                                                           2025-08-14 00:28:51.216 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  24%|██▍       | 5/21 [00:00<00:01, 12.01it/s]
    Running batch inference:  29%|██▊       | 6/21 [00:00<00:01, 10.74it/s]
                                                                           2025-08-14 00:28:51.334 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  29%|██▊       | 6/21 [00:00<00:01, 10.74it/s]
                                                                           2025-08-14 00:28:51.394 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  33%|███▎      | 7/21 [00:00<00:01, 10.74it/s]
    Running batch inference:  38%|███▊      | 8/21 [00:00<00:01, 11.87it/s]
                                                                           2025-08-14 00:28:51.479 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  38%|███▊      | 8/21 [00:00<00:01, 11.87it/s]
                                                                           2025-08-14 00:28:51.547 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  43%|████▎     | 9/21 [00:00<00:01, 11.87it/s]
    Running batch inference:  48%|████▊     | 10/21 [00:00<00:00, 12.08it/s]
                                                                            2025-08-14 00:28:51.650 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  48%|████▊     | 10/21 [00:00<00:00, 12.08it/s]
                                                                            2025-08-14 00:28:51.689 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  52%|█████▏    | 11/21 [00:00<00:00, 12.08it/s]
    Running batch inference:  57%|█████▋    | 12/21 [00:00<00:00, 12.82it/s]
                                                                            2025-08-14 00:28:51.785 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  57%|█████▋    | 12/21 [00:01<00:00, 12.82it/s]
                                                                            2025-08-14 00:28:51.827 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  62%|██████▏   | 13/21 [00:01<00:00, 12.82it/s]
    Running batch inference:  67%|██████▋   | 14/21 [00:01<00:00, 13.27it/s]
                                                                            2025-08-14 00:28:51.918 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  67%|██████▋   | 14/21 [00:01<00:00, 13.27it/s]
                                                                            2025-08-14 00:28:51.960 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  71%|███████▏  | 15/21 [00:01<00:00, 13.27it/s]
    Running batch inference:  76%|███████▌  | 16/21 [00:01<00:00, 13.56it/s]
                                                                            2025-08-14 00:28:52.053 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  76%|███████▌  | 16/21 [00:01<00:00, 13.56it/s]
                                                                            2025-08-14 00:28:52.123 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  81%|████████  | 17/21 [00:01<00:00, 13.56it/s]
    Running batch inference:  86%|████████▌ | 18/21 [00:01<00:00, 13.36it/s]
                                                                            2025-08-14 00:28:52.214 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  86%|████████▌ | 18/21 [00:01<00:00, 13.36it/s]
                                                                            2025-08-14 00:28:52.282 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  90%|█████████ | 19/21 [00:01<00:00, 13.36it/s]
    Running batch inference:  95%|█████████▌| 20/21 [00:01<00:00, 13.32it/s]
                                                                            2025-08-14 00:28:52.374 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  95%|█████████▌| 20/21 [00:01<00:00, 13.32it/s]
                                                                            2025-08-14 00:28:52.385 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 
    2025-08-14 00:28:52.422 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays
    2025-08-14 00:28:52.425 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 
    2025-08-14 00:28:52.501 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 
    2025-08-14 00:28:52.571 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 
    2025-08-14 00:28:52.676 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 




.. GENERATED FROM PYTHON SOURCE LINES 379-387

.. code-block:: Python


    print(
        f"\nNon-blocking async zarr store inference time: {zarr_nonblocking_async_clock}s"
    )
    print(
        f"Compressed non-blocking async zarr store size: {get_folder_size('outputs/17_io_nonblocking_async.zarr'):.2f} MB"
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    Non-blocking async zarr store inference time: 2.3087241649627686s
    Compressed non-blocking async zarr store size: 413.08 MB




.. GENERATED FROM PYTHON SOURCE LINES 388-407

Remote Non-Blocking Async Zarr IO
----------------------------------
This IO backend can be further customized by changing the Fsspec Filesystem used by
the Zarr store which can be controlled via the `fs_factory` parameter.
Note that this is a factory method, the IO backend will need to create multiple
instances of the file system.
Some examples that may be of interest are:

- :code:`from fsspec.implementations.local import LocalFileSystem` (Default, local store)
- :code:`from fsspec.implementations.memory import MemoryFileSystem` (in-memory store)
- :code:`from s3fs import S3FileSystem` (Remote S3 store)

For sake of example, lets have a look at writing to a remote store would require.
Compression is a must in this instances, since we need to minimize the data transfer
over the network.
The file system factory is set to S3 with the appropiate credentials in a partial
callable object.
Lastly we can increase the max number of thread workers with the `pool_size` parameter
to further boost performance.

.. GENERATED FROM PYTHON SOURCE LINES 409-445

.. code-block:: Python


    import functools

    import s3fs

    if "S3FS_KEY" in os.environ and "S3FS_SECRET" in os.environ:
        # Remember, needs to be a callable
        fs_factory = functools.partial(
            s3fs.S3FileSystem,
            key=os.environ["S3FS_KEY"],
            secret=os.environ["S3FS_SECRET"],
            client_kwargs={"endpoint_url": os.environ.get("S3FS_ENDPOINT", None)},
            asynchronous=True,
        )
        io = AsyncZarrBackend(
            "earth2studio/ci/example/17_io_async.zarr",
            parallel_coords=parallel_coords,
            fs_factory=fs_factory,
            blocking=False,
            pool_size=16,
            zarr_codecs=zarr.codecs.BloscCodec(
                cname="zstd", clevel=3, shuffle=zarr.codecs.BloscShuffle.shuffle
            ),
        )
        christmas_five_day_ensemble(times, 4, model, ds, io, pt, device=device)
        # IMPORTANT: Make sure to call close to ensure IO backend threads have finished!
        io.close()

        # To clean up the zarr store you can use
        # fs = s3fs.S3FileSystem(
        #     key=os.environ["S3FS_KEY"],
        #     secret=os.environ["S3FS_SECRET"],
        #     client_kwargs={"endpoint_url": os.environ.get("S3FS_ENDPOINT", None)},
        # )
        # fs.rm("earth2studio/ci/example/17_io_async.zarr", recursive=True)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2025-08-14 00:28:52.722 | DEBUG    | earth2studio.io.async_zarr:__init__:167 - Setting up Zarr object pool of size 16, may take a bit
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.249 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 422682974-1171397
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.295 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 251866913-804464
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.319 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 330483332-833835
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.341 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 399402626-989950
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.363 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 410101849-875378
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.385 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 209450878-718645
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.406 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221219/18/atmos/gfs.t18z.pgrb2.0p25.f000 295463736-857297
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:01,  5.58it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 39.05it/s]
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.437 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 331696727-829753
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.459 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 296814817-852960
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.481 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 410972364-870639
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.503 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 253345828-804505
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.524 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 210327553-720496
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.546 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 400334303-985030
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]                                                            2025-08-14 00:29:23.568 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20221220/00/atmos/gfs.t00z.pgrb2.0p25.f000 423575610-1170377
    Fetching GFS data:   0%|          | 0/7 [00:00<?, ?it/s]    Fetching GFS data:  14%|█▍        | 1/7 [00:00<00:00,  6.48it/s]    Fetching GFS data: 100%|██████████| 7/7 [00:00<00:00, 45.33it/s]

    Running batch inference:   0%|          | 0/5 [00:00<?, ?it/s]
                                                                  2025-08-14 00:29:24.378 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array ensemble to zarr store

    Running batch inference:   0%|          | 0/5 [00:00<?, ?it/s]
                                                                  2025-08-14 00:29:29.235 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array time to zarr store

    Running batch inference:   0%|          | 0/5 [00:05<?, ?it/s]
                                                                  2025-08-14 00:29:32.380 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lead_time to zarr store

    Running batch inference:   0%|          | 0/5 [00:08<?, ?it/s]
                                                                  2025-08-14 00:29:33.466 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lat to zarr store

    Running batch inference:   0%|          | 0/5 [00:09<?, ?it/s]
                                                                  2025-08-14 00:29:35.158 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:311 - Writing coordinate array lon to zarr store

    Running batch inference:   0%|          | 0/5 [00:11<?, ?it/s]
                                                                  2025-08-14 00:29:40.555 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array t2m with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/5 [00:16<?, ?it/s]
                                                                  2025-08-14 00:29:41.965 | DEBUG    | earth2studio.io.async_zarr:_initialize_arrays:345 - Initializing array tcwv with shape (8, 1, 21, 721, 1440) with chunks (8, 1, 1, 721, 1440) dtype <class 'numpy.float32'>

    Running batch inference:   0%|          | 0/5 [00:18<?, ?it/s]
    Running batch inference:  20%|██        | 1/5 [00:21<01:26, 21.55s/it]
                                                                          2025-08-14 00:29:45.247 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  20%|██        | 1/5 [00:21<01:26, 21.55s/it]
    Running batch inference:  40%|████      | 2/5 [00:25<00:34, 11.40s/it]
                                                                          2025-08-14 00:29:49.548 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  40%|████      | 2/5 [00:25<00:34, 11.40s/it]
    Running batch inference:  60%|██████    | 3/5 [00:28<00:14,  7.26s/it]
                                                                          2025-08-14 00:29:51.875 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  60%|██████    | 3/5 [00:28<00:14,  7.26s/it]
    Running batch inference:  80%|████████  | 4/5 [00:30<00:05,  5.40s/it]
                                                                          2025-08-14 00:29:54.423 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays

    Running batch inference:  80%|████████  | 4/5 [00:30<00:05,  5.40s/it]
    Running batch inference: 100%|██████████| 5/5 [00:33<00:00,  4.59s/it]
                                                                          2025-08-14 00:29:57.503 | DEBUG    | earth2studio.io.async_zarr:_limit_pool_size:480 - In IO thread pool throttle, limiting 
    2025-08-14 00:29:57.569 | DEBUG    | earth2studio.io.async_zarr:_write:614 - Writing 1 chunks to 2 Zarr arrays




.. GENERATED FROM PYTHON SOURCE LINES 446-450

Post-Processing
---------------
Lastly, we can plot the each of the local Zarr stores to verify that indeed they are
the same.

.. GENERATED FROM PYTHON SOURCE LINES 452-492

.. code-block:: Python

    import matplotlib.pyplot as plt
    import xarray as xr

    # Load the datasets
    ds_async = xr.open_zarr("outputs/17_io_async.zarr", consolidated=False)
    ds_nonblocking = xr.open_zarr(
        "outputs/17_io_nonblocking_async.zarr", consolidated=False
    )
    ds_sync = xr.open_zarr("outputs/17_io_sync.zarr")
    ds_nc = xr.open_dataset("outputs/17_io_sync.nc")

    # Create a 2x2 subplot grid
    fig, axes = plt.subplots(2, 2, figsize=(12, 8))
    fig.suptitle("Comparison of mean t2m across IO Backends")

    # Plot t2m from each dataset
    axes[0, 0].imshow(
        ds_async.t2m.isel(time=0, lead_time=8).mean(dim="ensemble"), vmin=250, vmax=320
    )
    axes[0, 0].set_title("Async Zarr")

    axes[0, 1].imshow(
        ds_nonblocking.t2m.isel(time=0, lead_time=8).mean(dim="ensemble"),
        vmin=250,
        vmax=320,
    )
    axes[0, 1].set_title("Non-blocking Async Zarr")

    axes[1, 0].imshow(
        ds_sync.t2m.isel(time=0, lead_time=8).mean(dim="ensemble"), vmin=250, vmax=320
    )
    axes[1, 0].set_title("Sync Zarr")

    axes[1, 1].imshow(
        ds_nc.t2m.isel(time=0, lead_time=8).mean(dim="ensemble"), vmin=250, vmax=320
    )
    axes[1, 1].set_title("NetCDF")

    plt.tight_layout()
    plt.savefig("outputs/17_io_performance.jpg", bbox_inches="tight")



.. image-sg:: /examples/images/sphx_glr_17_io_performance_001.png
   :alt: Comparison of mean t2m across IO Backends, Async Zarr, Non-blocking Async Zarr, Sync Zarr, NetCDF
   :srcset: /examples/images/sphx_glr_17_io_performance_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (2 minutes 17.359 seconds)


.. _sphx_glr_download_examples_17_io_performance.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 17_io_performance.ipynb <17_io_performance.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 17_io_performance.py <17_io_performance.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 17_io_performance.zip <17_io_performance.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
