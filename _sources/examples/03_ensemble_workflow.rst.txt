
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/03_ensemble_workflow.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_03_ensemble_workflow.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_03_ensemble_workflow.py:


Running Ensemble Inference
==========================

Simple ensemble inference workflow.

This example will demonstrate how to run a simple inference workflow to generate a
ensemble forecast using one of the built in models of Earth-2 Inference
Studio.

In this example you will learn:

- How to instantiate a built in prognostic model
- Creating a data source and IO object
- Select a perturbation method
- Running a simple built in workflow for ensembling
- Post-processing results

.. GENERATED FROM PYTHON SOURCE LINES 36-43

.. code-block:: Python

    # /// script
    # dependencies = [
    #   "earth2studio[fcn,perturbation] @ git+https://github.com/NVIDIA/earth2studio.git",
    #   "cartopy",
    # ]
    # ///








.. GENERATED FROM PYTHON SOURCE LINES 44-49

Set Up
------
All workflows inside Earth2Studio require constructed components to be
handed to them. In this example, we will use the built in ensemble workflow
:py:meth:`earth2studio.run.ensemble`.

.. GENERATED FROM PYTHON SOURCE LINES 51-55

.. literalinclude:: ../../earth2studio/run.py
   :language: python
   :start-after: # sphinx - ensemble start
   :end-before: # sphinx - ensemble end

.. GENERATED FROM PYTHON SOURCE LINES 57-63

We need the following:

- Prognostic Model: Use the built in FourCastNet model :py:class:`earth2studio.models.px.FCN`.
- Perturbation Method: Use the Spherical Gaussian Method :py:class:`earth2studio.perturbation.SphericalGaussian`.
- Datasource: Pull data from the GFS data api :py:class:`earth2studio.data.GFS`.
- IO Backend: Save the outputs into a Zarr store :py:class:`earth2studio.io.ZarrBackend`.

.. GENERATED FROM PYTHON SOURCE LINES 65-98

.. code-block:: Python

    import os

    os.makedirs("outputs", exist_ok=True)
    from dotenv import load_dotenv

    load_dotenv()  # TODO: make common example prep function

    import numpy as np

    from earth2studio.data import GFS
    from earth2studio.io import ZarrBackend
    from earth2studio.models.px import FCN
    from earth2studio.perturbation import SphericalGaussian
    from earth2studio.run import ensemble

    # Load the default model package which downloads the check point from NGC
    package = FCN.load_default_package()
    model = FCN.load_model(package)

    # Instantiate the pertubation method
    sg = SphericalGaussian(noise_amplitude=0.15)

    # Create the data source
    data = GFS()

    # Create the IO handler, store in memory
    chunks = {"ensemble": 1, "time": 1, "lead_time": 1}
    io = ZarrBackend(
        file_name="outputs/03_ensemble_sg.zarr",
        chunks=chunks,
        backend_kwargs={"overwrite": True},
    )








.. GENERATED FROM PYTHON SOURCE LINES 99-108

Execute the Workflow
--------------------
With all components initialized, running the workflow is a single line of Python code.
Workflow will return the provided IO object back to the user, which can be used to
then post process. Some have additional APIs that can be handy for post-processing or
saving to file. Check the API docs for more information.

For the forecast we will predict for 10 steps (for FCN, this is 60 hours) with 8 ensemble
members which will be ran in 2 batches with batch size 4.

.. GENERATED FROM PYTHON SOURCE LINES 110-126

.. code-block:: Python


    nsteps = 10
    nensemble = 8
    batch_size = 2
    io = ensemble(
        ["2024-01-01"],
        nsteps,
        nensemble,
        model,
        data,
        io,
        sg,
        batch_size=batch_size,
        output_coords={"variable": np.array(["t2m", "tcwv"])},
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    2025-07-18 21:18:25.942 | INFO     | earth2studio.run:ensemble:315 - Running ensemble inference!
    2025-07-18 21:18:25.942 | INFO     | earth2studio.run:ensemble:323 - Inference device: cuda
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:25.986 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 330670600-938837
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.014 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 393705863-838502
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.040 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 0-993995
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.067 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 253514796-920355
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.094 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 247857131-804857
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.121 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 402321768-876246
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.145 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 324794050-867372
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.171 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 391722290-987401
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.196 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 452597070-961302
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.223 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 414179964-1179422
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.248 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 323061199-895080
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.275 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 252556659-958137
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.302 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 247139652-717479
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.329 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 199346060-588823
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.355 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 451628742-968328
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.381 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 193737151-726758
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.408 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 387322476-948106
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.434 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 386359113-963363
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.461 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 143527711-755695
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.488 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 246334297-805355
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.513 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 323956279-837771
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.539 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 406629528-962408
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.566 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 194463909-743465
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.592 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 199934883-595444
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.619 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 407591936-940269
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]                                                             2025-07-18 21:18:26.646 | DEBUG    | earth2studio.data.gfs:fetch_array:380 - Fetching GFS grib file: noaa-gfs-bdp-pds/gfs.20240101/00/atmos/gfs.t00z.pgrb2.0p25.f000 329739828-930772
    Fetching GFS data:   0%|          | 0/26 [00:00<?, ?it/s]    Fetching GFS data:   4%|▍         | 1/26 [00:00<00:17,  1.46it/s]    Fetching GFS data: 100%|██████████| 26/26 [00:00<00:00, 37.85it/s]
    2025-07-18 21:18:26.740 | SUCCESS  | earth2studio.run:ensemble:345 - Fetched data from GFS
    2025-07-18 21:18:26.746 | WARNING  | earth2studio.io.zarr:add_array:200 - Datetime64 not supported in zarr 3.0, converting to int64 nanoseconds since epoch
    2025-07-18 21:18:26.748 | WARNING  | earth2studio.io.zarr:add_array:206 - Timedelta64 not supported in zarr 3.0, converting to int64 nanoseconds since epoch
    2025-07-18 21:18:26.763 | INFO     | earth2studio.run:ensemble:373 - Starting 8 Member Ensemble Inference with             4 number of batches.


    Total Ensemble Batches:   0%|          | 0/4 [00:00<?, ?it/s]
    Running batch 0 inference:   0%|          | 0/11 [00:00<?, ?it/s]
    Running batch 0 inference:   9%|▉         | 1/11 [00:00<00:02,  3.54it/s]
    Running batch 0 inference:  18%|█▊        | 2/11 [00:00<00:03,  2.75it/s]
    Running batch 0 inference:  27%|██▋       | 3/11 [00:01<00:03,  2.63it/s]
    Running batch 0 inference:  36%|███▋      | 4/11 [00:01<00:02,  2.58it/s]
    Running batch 0 inference:  45%|████▌     | 5/11 [00:01<00:02,  2.56it/s]
    Running batch 0 inference:  55%|█████▍    | 6/11 [00:02<00:01,  2.54it/s]
    Running batch 0 inference:  64%|██████▎   | 7/11 [00:02<00:01,  2.54it/s]
    Running batch 0 inference:  73%|███████▎  | 8/11 [00:03<00:01,  2.54it/s]
    Running batch 0 inference:  82%|████████▏ | 9/11 [00:03<00:00,  2.54it/s]
    Running batch 0 inference:  91%|█████████ | 10/11 [00:03<00:00,  2.54it/s]
    Running batch 0 inference: 100%|██████████| 11/11 [00:04<00:00,  2.53it/s]
                                                                              

    Total Ensemble Batches:  25%|██▌       | 1/4 [00:07<00:23,  7.98s/it]
    Running batch 2 inference:   0%|          | 0/11 [00:00<?, ?it/s]
    Running batch 2 inference:   9%|▉         | 1/11 [00:00<00:02,  4.22it/s]
    Running batch 2 inference:  18%|█▊        | 2/11 [00:00<00:02,  3.10it/s]
    Running batch 2 inference:  27%|██▋       | 3/11 [00:01<00:02,  2.78it/s]
    Running batch 2 inference:  36%|███▋      | 4/11 [00:01<00:02,  2.67it/s]
    Running batch 2 inference:  45%|████▌     | 5/11 [00:01<00:02,  2.62it/s]
    Running batch 2 inference:  55%|█████▍    | 6/11 [00:02<00:01,  2.61it/s]
    Running batch 2 inference:  64%|██████▎   | 7/11 [00:02<00:01,  2.58it/s]
    Running batch 2 inference:  73%|███████▎  | 8/11 [00:02<00:01,  2.56it/s]
    Running batch 2 inference:  82%|████████▏ | 9/11 [00:03<00:00,  2.55it/s]
    Running batch 2 inference:  91%|█████████ | 10/11 [00:03<00:00,  2.60it/s]
    Running batch 2 inference: 100%|██████████| 11/11 [00:04<00:00,  2.63it/s]
                                                                              

    Total Ensemble Batches:  50%|█████     | 2/4 [00:15<00:15,  7.82s/it]
    Running batch 4 inference:   0%|          | 0/11 [00:00<?, ?it/s]
    Running batch 4 inference:   9%|▉         | 1/11 [00:00<00:02,  4.38it/s]
    Running batch 4 inference:  18%|█▊        | 2/11 [00:00<00:02,  3.09it/s]
    Running batch 4 inference:  27%|██▋       | 3/11 [00:00<00:02,  2.97it/s]
    Running batch 4 inference:  36%|███▋      | 4/11 [00:01<00:02,  2.81it/s]
    Running batch 4 inference:  45%|████▌     | 5/11 [00:01<00:02,  2.72it/s]
    Running batch 4 inference:  55%|█████▍    | 6/11 [00:02<00:01,  2.78it/s]
    Running batch 4 inference:  64%|██████▎   | 7/11 [00:02<00:01,  2.69it/s]
    Running batch 4 inference:  73%|███████▎  | 8/11 [00:02<00:01,  2.65it/s]
    Running batch 4 inference:  82%|████████▏ | 9/11 [00:03<00:00,  2.60it/s]
    Running batch 4 inference:  91%|█████████ | 10/11 [00:03<00:00,  2.60it/s]
    Running batch 4 inference: 100%|██████████| 11/11 [00:04<00:00,  2.55it/s]
                                                                              

    Total Ensemble Batches:  75%|███████▌  | 3/4 [00:23<00:07,  7.73s/it]
    Running batch 6 inference:   0%|          | 0/11 [00:00<?, ?it/s]
    Running batch 6 inference:   9%|▉         | 1/11 [00:00<00:02,  4.41it/s]
    Running batch 6 inference:  18%|█▊        | 2/11 [00:00<00:02,  3.05it/s]
    Running batch 6 inference:  27%|██▋       | 3/11 [00:01<00:02,  2.82it/s]
    Running batch 6 inference:  36%|███▋      | 4/11 [00:01<00:02,  2.70it/s]
    Running batch 6 inference:  45%|████▌     | 5/11 [00:01<00:02,  2.64it/s]
    Running batch 6 inference:  55%|█████▍    | 6/11 [00:02<00:01,  2.62it/s]
    Running batch 6 inference:  64%|██████▎   | 7/11 [00:02<00:01,  2.58it/s]
    Running batch 6 inference:  73%|███████▎  | 8/11 [00:02<00:01,  2.59it/s]
    Running batch 6 inference:  82%|████████▏ | 9/11 [00:03<00:00,  2.58it/s]
    Running batch 6 inference:  91%|█████████ | 10/11 [00:03<00:00,  2.56it/s]
    Running batch 6 inference: 100%|██████████| 11/11 [00:04<00:00,  2.56it/s]
                                                                              

    Total Ensemble Batches: 100%|██████████| 4/4 [00:31<00:00,  7.72s/it]    Total Ensemble Batches: 100%|██████████| 4/4 [00:31<00:00,  7.75s/it]
    2025-07-18 21:18:57.768 | SUCCESS  | earth2studio.run:ensemble:423 - Inference complete




.. GENERATED FROM PYTHON SOURCE LINES 127-133

Post Processing
---------------
The last step is to post process our results. Cartopy is a great library for plotting
fields on projections of a sphere.

Notice that the Zarr IO function has additional APIs to interact with the stored data.

.. GENERATED FROM PYTHON SOURCE LINES 135-191

.. code-block:: Python

    import cartopy.crs as ccrs
    import matplotlib.pyplot as plt

    forecast = "2024-01-01"


    def plot_(axi, data, title, cmap):
        """Convenience function for plotting pcolormesh."""
        # Plot the field using pcolormesh
        im = axi.pcolormesh(
            io["lon"][:],
            io["lat"][:],
            data,
            transform=ccrs.PlateCarree(),
            cmap=cmap,
        )
        plt.colorbar(im, ax=axi, shrink=0.6, pad=0.04)
        # Set title
        axi.set_title(title)
        # Add coastlines and gridlines
        axi.coastlines()
        axi.gridlines()


    for variable, cmap in zip(["tcwv"], ["Blues"]):
        step = 4  # lead time = 24 hrs

        plt.close("all")
        # Create a Robinson projection
        projection = ccrs.Robinson()

        # Create a figure and axes with the specified projection
        fig, (ax1, ax2, ax3) = plt.subplots(
            nrows=1, ncols=3, subplot_kw={"projection": projection}, figsize=(16, 3)
        )

        plot_(
            ax1,
            io[variable][0, 0, step],
            f"{forecast} - Lead time: {6*step}hrs - Member: {0}",
            cmap,
        )
        plot_(
            ax2,
            io[variable][1, 0, step],
            f"{forecast} - Lead time: {6*step}hrs - Member: {1}",
            cmap,
        )
        plot_(
            ax3,
            np.std(io[variable][:, 0, step], axis=0),
            f"{forecast} - Lead time: {6*step}hrs - Std",
            cmap,
        )

        plt.savefig(f"outputs/03_{forecast}_{variable}_{step}_ensemble.jpg")



.. image-sg:: /examples/images/sphx_glr_03_ensemble_workflow_001.png
   :alt: 2024-01-01 - Lead time: 24hrs - Member: 0, 2024-01-01 - Lead time: 24hrs - Member: 1, 2024-01-01 - Lead time: 24hrs - Std
   :srcset: /examples/images/sphx_glr_03_ensemble_workflow_001.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (1 minutes 19.075 seconds)


.. _sphx_glr_download_examples_03_ensemble_workflow.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 03_ensemble_workflow.ipynb <03_ensemble_workflow.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 03_ensemble_workflow.py <03_ensemble_workflow.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 03_ensemble_workflow.zip <03_ensemble_workflow.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
